<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chassis Verification</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    tr.single-found { background-color: #c6f6c6 !important; } /* green - permanent */
    tr.duplicate-found { background-color: #fff3b3 !important; } /* yellow - temporary */
    #statusBox { width: 230px; height: 28px; margin-bottom: 10px; font-weight: bold; text-align: center; color: white; line-height: 28px; }
  </style>
</head>
<body><h2>Stock Physical Verification</h2><div id="statusBox">Status</div>
<input type="file" id="fileInput" accept=".xlsx,.xls" />
<span id="fileName" style="margin-left:10px;font-weight:bold;color:#333"></span>
<br><br>
<input type="text" id="searchBox" placeholder="Enter Chassis Number" />
<button onclick="searchChassis()">Verify</button>
<button onclick="downloadExcelWithSummary()">Save & Summary</button><table id="dataTable"></table><!-- xlsx-js-style is required to SAVE COLORS in Excel --><script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script><script>
let excelData = [];

fileInput.onchange = function(e) {
  const fileLabel = document.getElementById('fileName');
  if (e.target.files.length > 0) {
    fileLabel.innerText = 'Loaded: ' + e.target.files[0].name;
  } else {
    fileLabel.innerText = '';
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    excelData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    renderTable();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
};

function renderTable() {
  const table = document.getElementById('dataTable');
  table.style.display = 'table';
  const table = document.getElementById('dataTable');
  table.innerHTML = '';
  excelData.forEach((row, i) => {
    const tr = document.createElement('tr');
    row.forEach(cell => {
      const td = document.createElement(i === 0 ? 'th' : 'td');
      td.innerText = cell;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

function searchChassis() {
  const val = document.getElementById('searchBox').value.trim();
  if(val === '') return;

  const rows = document.querySelectorAll('#dataTable tr');
  const statusBox = document.getElementById('statusBox');

  // ðŸ” Remove ONLY previous temporary yellow highlights
  rows.forEach((tr, i) => {
    if(i === 0) return;
    if(!tr.classList.contains('single-found')) {
      tr.classList.remove('duplicate-found');
    }
  });

  let matchedRows = [];

  rows.forEach((tr, i) => {
    if(i === 0) return;
    const cell = tr.querySelector('td:nth-child(2)');
    if(cell && cell.innerText.includes(val)) {
      matchedRows.push(tr);
    }
  });

  if(matchedRows.length === 0) {
    statusBox.innerText = 'Not Found';
    statusBox.style.backgroundColor = 'red';
    return;
  }

  if(matchedRows.length === 1) {
    statusBox.innerText = 'Verified';
    statusBox.style.backgroundColor = 'green';
    matchedRows[0].classList.add('single-found'); // permanent green
    matchedRows[0].classList.remove('duplicate-found');
  } else {
    statusBox.innerText = 'Duplicate';
    statusBox.style.backgroundColor = 'orange';
    matchedRows.forEach(tr => {
      if(!tr.classList.contains('single-found')) {
        tr.classList.add('duplicate-found'); // temporary yellow
      }
    });
  }
}

function downloadExcelWithSummary() {
  const table = document.getElementById('dataTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table);
  const range = XLSX.utils.decode_range(ws['!ref']);

  let verified = 0, duplicate = 0;

  for (let r = 1; r <= range.e.r; r++) {
    const tr = table.rows[r];
    let fill = null;

    if (tr.classList.contains('single-found')) {
      fill = { fgColor: { rgb: 'C6F6C6' } };
      verified++;
    } else if (tr.classList.contains('duplicate-found')) {
      fill = { fgColor: { rgb: 'FFF3B3' } };
      duplicate++;
    }

    if (fill) {
      for (let c = range.s.c; c <= range.e.c; c++) {
        const cellRef = XLSX.utils.encode_cell({ r, c });
        if (ws[cellRef]) ws[cellRef].s = { fill };
      }
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, 'Verification');

  const summaryData = [
    ['Summary'],
    ['Verified (Green)', verified],
    ['Duplicate (Yellow)', duplicate],
    ['Total Rows', table.rows.length - 1]
  ];

  const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

  XLSX.writeFile(wb, 'verified_stock_with_summary.xlsx');
}

    // Save color status
    if (i === 0) {
      row.push('ColorStatus');
    } else {
      const tr = table.rows[i];
      if (tr.classList.contains('single-found')) row.push('GREEN');
      else if (tr.classList.contains('duplicate-found')) row.push('YELLOW');
      else row.push('');
    }

    csv.push(row.join(','));
  }

  const blob = new Blob([csv.join('
')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'verified_stock.csv';
  a.click();
}
</script></body>
</html>
